# GCP VM Auto-Create and Shutdown Flow

## Your Questions Answered โ

### Q1: Auto-create when memory > 85%?
**โ YES - Fully Implemented!**

### Q2: CTRL+C shuts down VMs and shows costs?
**โ YES - With Enhanced Cost Display!**

---

## Complete Flow Diagram

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    LOCAL MACOS - NORMAL OPERATION                 โ
โ                                                                   โ
โ  Memory Usage: 60% (9.6GB / 16GB)                                โ
โ  Status: All components running locally                          โ
โ  GCP VMs: None                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ User opens many apps
                            โ Chrome, Cursor IDE, Docker...
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MEMORY PRESSURE INCREASES                      โ
โ                                                                   โ
โ  Memory Usage: 87% (13.9GB / 16GB)  โ Exceeds 85% threshold!    โ
โ  platform_memory_monitor detects: pressure_level = "high"        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Triggers callback
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              MAIN.PY - memory_pressure_callback()                 โ
โ                                                                   โ
โ  1. Detects pressure_level = "high"                              โ
โ  2. Initializes gcp_vm_manager                                   โ
โ  3. Gets memory snapshot from platform_memory_monitor            โ
โ  4. Calls intelligent_gcp_optimizer.should_create_vm()           โ
โ     โข Checks budget: $0.00 / $5.00 โ                            โ
โ     โข Checks VM limit: 0 / 2 VMs โ                              โ
โ     โข Analyzes memory pressure: 87% > 85% โ                     โ
โ     โข Decision: CREATE VM (confidence: 89%)                      โ
โ                                                                   โ
โ  5. Calls gcp_vm_manager.create_vm()                             โ
โ     โข Components: ['VISION', 'CHATBOTS']                         โ
โ     โข Trigger: "Memory pressure: high - RAM >85%"                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Creates GCP VM
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  GCP VM CREATION (30-60 seconds)                  โ
โ                                                                   โ
โ  1. Google Compute Engine API:                                   โ
โ     โข Machine: e2-highmem-4 (4 vCPU, 32GB RAM)                   โ
โ     โข Type: Spot VM ($0.029/hour)                                โ
โ     โข Zone: us-central1-a                                        โ
โ     โข Name: jarvis-backend-20251029-143022                       โ
โ                                                                   โ
โ  2. VM Starts โ gcp_vm_startup.sh runs automatically:            โ
โ     โข apt-get install python3, git, etc.                         โ
โ     โข Clone JARVIS repo                                          โ
โ     โข pip install dependencies                                   โ
โ     โข Start Cloud SQL Proxy                                      โ
โ     โข python3 main.py --port 8010                                โ
โ                                                                   โ
โ  3. Backend Ready:                                               โ
โ     โข External IP: http://34.10.137.70:8010                      โ
โ     โข Health check: โ HEALTHY                                   โ
โ                                                                   โ
โ  4. cost_tracker records:                                        โ
โ     โข Instance ID: 12345678901234567                             โ
โ     โข Created at: 2025-10-29 14:30:22                            โ
โ     โข Components: VISION, CHATBOTS                               โ
โ     โข Cost rate: $0.029/hour                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ VM Running
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    HYBRID OPERATION MODE                          โ
โ                                                                   โ
โ  LOCAL (macOS):                                                  โ
โ  โข Memory: 65% (10.4GB / 16GB) โ Reduced!                       โ
โ  โข Components: VOICE, VOICE_UNLOCK, WAKE_WORD, MONITORING       โ
โ                                                                   โ
โ  CLOUD (GCP VM - 32GB RAM):                                      โ
โ  โข Memory: 28% (9GB / 32GB) โ Plenty of headroom!               โ
โ  โข Components: VISION, CHATBOTS                                  โ
โ  โข Cost: $0.029/hour = $0.00048/minute                           โ
โ                                                                   โ
โ  ๐ Monitoring Loop (every 30s):                                 โ
โ  โข Health checks VM                                              โ
โ  โข Updates cost: uptime_hours * $0.029                           โ
โ  โข Checks max lifetime (3 hours)                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ User presses CTRL+C or CMD+DELETE
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 GRACEFUL SHUTDOWN (main.py lifespan)              โ
โ                                                                   โ
โ  ๐ Shutting down JARVIS backend...                              โ
โ                                                                   โ
โ  1. Broadcast shutdown to WebSocket clients                      โ
โ                                                                   โ
โ  2. Cleanup GCP VM Manager:                                      โ
โ     ๐งน Cleaning up all VMs: Manager shutdown                     โ
โ                                                                   โ
โ     For each VM:                                                 โ
โ       โข Update cost: uptime_hours * cost_per_hour               โ
โ       โข ๐ Terminating VM: jarvis-backend-20251029-143022       โ
โ       โข    Reason: Manager shutdown                              โ
โ       โข    Uptime: 1.47 hours                                    โ
โ       โข    Cost: $0.0427                                         โ
โ       โข Record termination in cost_tracker                       โ
โ       โข Delete VM via Google Compute Engine API                  โ
โ       โข โ VM terminated                                         โ
โ                                                                   โ
โ     ๐ฐ COST SUMMARY (displayed prominently):                     โ
โ     ============================================================  โ
โ     ๐ฐ GCP VM COST SUMMARY                                       โ
โ     ============================================================  โ
โ        VMs Terminated:  1                                        โ
โ        Total Uptime:    1.47 hours                               โ
โ        Session Cost:    $0.0427                                  โ
โ        Total Lifetime:  $0.2145 (all sessions)                   โ
โ     ============================================================  โ
โ                                                                   โ
โ  3. Shutdown Cost Tracking System                                โ
โ     โ Cost Tracking System shutdown complete                    โ
โ                                                                   โ
โ  4. Stop other components...                                     โ
โ                                                                   โ
โ  โ JARVIS stopped gracefully                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Key Implementation Details

### 1. Auto-Create Trigger (Memory > 85%)

**File:** `backend/core/platform_memory_monitor.py`

```python
# Lines 193-203
if pressure_level == "critical" or snapshot.macos_is_swapping:
    snapshot.pressure_level = "critical"
    snapshot.gcp_shift_recommended = True
    snapshot.gcp_shift_urgent = True

elif pressure_level == "warn":  # This is the 85% threshold!
    snapshot.pressure_level = "high"
    snapshot.gcp_shift_recommended = True
```

**File:** `backend/main.py`

```python
# Lines 850-923
async def memory_pressure_callback(pressure_level: str):
    """Triggers GCP VM creation when memory pressure is high/critical"""

    # Only create VM on high or critical pressure
    if pressure_level not in ['high', 'critical']:
        return

    # Check if VM needed
    should_create, reason, confidence = await gcp_vm_manager.should_create_vm(
        snapshot, trigger_reason=f"Memory pressure: {pressure_level}"
    )

    if should_create:
        # Create VM with components to offload
        vm_instance = await gcp_vm_manager.create_vm(
            components=['VISION', 'CHATBOTS'],  # Or more if critical
            trigger_reason=f"Memory pressure: {pressure_level}",
            metadata={"pressure_level": pressure_level}
        )
```

### 2. CTRL+C Shutdown with Cost Display

**File:** `backend/main.py`

```python
# Lines 1894-1902 - Called when CTRL+C is pressed
@asynccontextmanager
async def lifespan(app: FastAPI):
    # ... startup code ...

    yield  # Application runs

    # CTRL+C triggers this cleanup code:

    # Cleanup GCP VM Manager (before cost tracker to finalize costs)
    if gcp_vm_manager:
        logger.info("๐งน Cleaning up GCP VMs...")
        await gcp_vm_manager.cleanup()  # โ Terminates all VMs + shows costs
        logger.info("โ GCP VM Manager cleanup complete")
```

**File:** `backend/core/gcp_vm_manager.py`

```python
# Lines 602-637 - Enhanced with cost summary
async def cleanup_all_vms(self, reason: str = "System shutdown"):
    """Terminate all managed VMs with cost summary"""

    # Calculate total costs before terminating
    total_session_cost = 0.0
    total_uptime_hours = 0.0
    vm_count = len(self.managed_vms)

    for vm in self.managed_vms.values():
        vm.update_cost()  # Calculate final cost
        total_session_cost += vm.total_cost
        total_uptime_hours += vm.uptime_hours

    # Terminate all VMs (calls terminate_vm for each)
    # ... termination code ...

    # Display prominent cost summary
    logger.info("="*60)
    logger.info("๐ฐ GCP VM COST SUMMARY")
    logger.info("="*60)
    logger.info(f"   VMs Terminated:  {vm_count}")
    logger.info(f"   Total Uptime:    {total_uptime_hours:.2f} hours")
    logger.info(f"   Session Cost:    ${total_session_cost:.4f}")
    logger.info(f"   Total Lifetime:  ${self.stats['total_cost']:.4f}")
    logger.info("="*60)
```

### 3. Per-VM Termination Cost Display

**File:** `backend/core/gcp_vm_manager.py`

```python
# Lines 490-538
async def terminate_vm(self, vm_name: str, reason: str = "Manual termination") -> bool:
    """Terminate a VM instance"""

    # Update cost before termination
    vm.update_cost()

    # Record in cost tracker
    if self.cost_tracker:
        await self.cost_tracker.record_vm_termination(
            instance_id=vm.instance_id,
            reason=reason,
            total_cost=vm.total_cost
        )

    # Delete the VM via Google Compute Engine API
    operation = await asyncio.to_thread(
        self.instances_client.delete,
        project=self.config.project_id,
        zone=self.config.zone,
        instance=vm_name
    )

    await self._wait_for_operation(operation)

    # Display individual VM cost
    logger.info(f"โ VM terminated: {vm_name}")
    logger.info(f"   Uptime: {vm.uptime_hours:.2f}h")
    logger.info(f"   Cost: ${vm.total_cost:.4f}")  # โ Shows individual cost

    return True
```

---

## Safety Features

### 1. Budget Protection
```python
# Won't create VM if daily budget exceeded
daily_cost = await cost_tracker.get_daily_cost()
if daily_cost >= daily_budget_usd:
    return False, f"Daily budget exceeded: ${daily_cost:.2f}"
```

### 2. VM Count Limits
```python
# Won't create more than max_concurrent_vms (default: 2)
active_vms = len([vm for vm in managed_vms if vm.state == RUNNING])
if active_vms >= max_concurrent_vms:
    return False, f"Max concurrent VMs reached: {active_vms} / {max_concurrent_vms}"
```

### 3. Auto-Termination
```python
# VMs auto-terminate after max_vm_lifetime_hours (default: 3 hours)
if vm.uptime_hours >= max_vm_lifetime_hours:
    await terminate_vm(vm_name, reason="Max lifetime exceeded")
```

### 4. Graceful Shutdown on CTRL+C
- All VMs terminated before exit
- Costs calculated and displayed
- No orphaned VMs running
- Cost tracker records everything

---

## Example Session Output

```bash
$ python main.py

๐ Starting optimized JARVIS backend...
โ๏ธ  GCP VM auto-creation enabled
โ Memory pressure callback registered
โ Dynamic component loading enabled

# ... normal operation ...

๐ Memory pressure changed: high
๐ Creating GCP Spot VM: RAM >85% (confidence: 89%)
โณ VM creation operation started: operation-123456
โ VM created successfully: jarvis-backend-20251029-143022
   External IP: 34.10.137.70
   Internal IP: 10.128.0.42
   Cost: $0.029/hour

# ... VM running for 1.47 hours ...

^C  # User presses CTRL+C

๐ Shutting down JARVIS backend...
๐งน Cleaning up GCP VMs...
๐งน Cleaning up all VMs: Manager shutdown

๐ Terminating VM: jarvis-backend-20251029-143022 (Reason: Manager shutdown)
โ VM terminated: jarvis-backend-20251029-143022
   Uptime: 1.47h
   Cost: $0.0427

โ All VMs cleaned up
============================================================
๐ฐ GCP VM COST SUMMARY
============================================================
   VMs Terminated:  1
   Total Uptime:    1.47 hours
   Session Cost:    $0.0427
   Total Lifetime:  $0.2145
============================================================

โ GCP VM Manager cleanup complete
โ Cost Tracking System shutdown complete
โ JARVIS stopped gracefully
```

---

## Cost Tracking Files

All costs are tracked in these files:
1. `cost_tracker.py` - Persistent database of all VM sessions
2. `gcp_vm_manager.py` - In-memory tracking of current session
3. Log files - Full audit trail

You can also check costs anytime:
```bash
cd backend
python3 core/gcp_vm_status.py --costs
```

---

## Summary

โ **Auto-create when memory > 85%**: YES - Fully implemented
โ **CTRL+C shuts down VMs**: YES - Graceful cleanup
โ **Shows costs on shutdown**: YES - Prominent display
โ **Prevents runaway costs**: YES - Budget limits, auto-termination, concurrent limits

**You're protected!** ๐ก๏ธ๐ฐ
