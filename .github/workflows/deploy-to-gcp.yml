name: Deploy JARVIS to GCP

on:
  push:
    branches:
      - main
      - multi-monitor-support  # Also deploy from your current branch
    paths:
      - 'backend/**'  # Only deploy when backend code changes
      - '.github/workflows/deploy-to-gcp.yml'

jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to VM
        run: |
          # Copy deployment script to VM and execute
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --command='bash -s' <<'ENDSSH'
          set -e

          echo "üöÄ Starting JARVIS deployment..."

          # Stop running backend
          echo "‚è∏Ô∏è  Stopping existing backend..."
          pkill -f uvicorn || true
          sleep 2

          # Pull latest changes
          echo "üì• Pulling latest code..."
          cd ~/backend
          git config --global --add safe.directory ~/backend
          git fetch --all
          git reset --hard origin/${{ github.ref_name }}

          # Install/update dependencies if requirements changed
          echo "üì¶ Checking dependencies..."
          cd ~/backend/backend
          if [ -f requirements-cloud.txt ]; then
            venv/bin/pip install -q -r requirements-cloud.txt
          fi

          # Start backend
          echo "‚ñ∂Ô∏è  Starting backend..."
          cd ~/backend/backend
          nohup venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8010 > jarvis.log 2>&1 &

          # Wait for backend to start
          sleep 8

          # Health check
          echo "üè• Health check..."
          if curl -s http://localhost:8010/health > /dev/null; then
            echo "‚úÖ Deployment successful!"
            echo "üåê Backend running at http://34.10.137.70:8010"
          else
            echo "‚ùå Health check failed"
            tail -50 jarvis.log
            exit 1
          fi
          ENDSSH

      - name: Deployment Summary
        run: |
          echo "‚úÖ JARVIS deployed successfully!"
          echo "üìä Commit: ${{ github.sha }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üåê URL: http://34.10.137.70:8010"
